@{
    ViewData["Title"] = "Downtime Task";
}
<div class="container-fluid">
    <div class="panel-default">
        <div class="panel-heading"><i class="fa fa-cogs "></i> @ViewData["Title"]</div>
        <div class="panel-body">
            <div class="row">
                <div class="col-lg-2 col-xs-3 col-sm-3 col-md-2" style="display:none">
                    <label class="form-label"> System:</label>
                    <select id="system-select" class="form-control selectpicker" title="Select System" data-size="6" multiple data-max-options="1">
                    </select>
                </div>
                <div class="col-lg-2 col-xs-3 col-sm-3 col-md-2">
                    <label class="form-label"> Department:</label>
                    <select id="department-select" class="form-control selectpicker" title="Select Department" data-size="6" multiple data-max-options="1" data-live-search="true"></select>
                </div>
                <div class="col-lg-2 col-xs-3 col-sm-3 col-md-2">
                    <label class="form-label"> Project:</label>
                    <select id="project-select" class="form-control selectpicker" title="Select Project" data-size="6" multiple data-max-options="1" data-live-search="true" onchange="getLine($('#line-select'),$('#project-select').val()); getStation($('#station-select'), $('#department-select').val(), $('#project-select').val(),$('#line-select').val())"> </select>
                </div>
                <div class="col-lg-2 col-xs-3 col-sm-3 col-md-2">
                    <label class="form-label"> Line:</label>
                    <select id="line-select" class="form-control selectpicker" title="Select Line" data-size="6" multiple data-max-options="1" data-live-search="true" onchange=" getStation($('#station-select'), $('#department-select').val(), $('#project-select').val(),$('#line-select').val());"></select>
                </div>
                <div class="col-lg-2 col-xs-3 col-sm-3 col-md-2">
                    <label class="form-label"> Station:</label>
                    <select id="station-select" class="form-control selectpicker" title="Select Station" data-size="6" multiple data-max-options="1" data-live-search="true"></select>
                </div>
                <div class="col-lg-2 col-md-2 col-xs-3 col-sm-3 ">
                    <label class="form-label" for="start"> Start Date:</label>
                    <div class='input-group date form_datetime searchTime'>
                        <input type='text' class="form-control" id='start' />
                        <span class="input-group-addon">
                            <span class="fa fa-calendar"></span>
                        </span>
                    </div>
                </div>
                <div class="col-lg-2 col-md-2 col-xs-3 col-sm-3 ">
                    <label class="form-label" for="end"> End Date: </label>
                    <div class='input-group date form_datetime searchTime'>
                        <input type='text' class="form-control" id='end' />
                        <span class="input-group-addon">
                            <span class="fa fa-calendar"></span>
                        </span>
                    </div>
                </div>
                <div class="col-lg-2 col-xs-3 col-sm-3 col-md-2">
                    <label class="form-label"> Incident Status:</label>
                    <select id="status-select" class="form-control selectpicker" title="Select Status" multiple data-max-options="1">
                        <option value="0">New Open</option>
                        <option value="1">On-going Check</option>
                        <option value="2">Closed</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-2 col-xs-3 col-sm-3 ">
                    <label class="form-label" for="id"> Ticket No: </label>
                    <input type='text' class="form-control" id='id' />
                </div>
                <div class="col-lg-2 col-md-2 col-xs-3 col-sm-3 ">
                    <label class="form-label" for="responser"> Repair Employee: </label>
                    <input type='text' class="form-control" id='responser' placeholder="--请输入工号 (WY0000) --" />
                </div>
                <div class="col-lg-1  col-xs-1 col-sm-1 col-md-1" style="padding-top:27px"><button type="button" class="btn btn-primary" id="search" onclick="GetDowntimeList()">Search</button></div>
                <div class="col-lg-1  col-xs-1 col-sm-1 col-md-1" style="padding-top:27px"><button type="button" class="btn btn-success" id="new" style="width: 100px">New Incident</button></div>
            </div>
        </div>
    </div>
</div>


<ul id="myTab" class="nav nav-tabs" role="tablist">
    <li class="nav-item"><a class="nav-link " id="analysis-tab" href="#analysisTab" data-toggle="tab" role="tab" aria-selected="false"> Troubleshooting Guide</a></li>
    <li class="nav-item"><a class="nav-link active" id="downtimet-tab" href="#downtimeTab" data-toggle="tab" role="tab" aria-selected="true">Downtime</a></li>
</ul>
<div id="myTabContent" class="tab-content border border-top-0">
    <div class="tab-pane fade" id="analysisTab" role="tabpanel" aria-labelledby="analysis-tab">
        <div class="row" style="margin-bottom:10px;margin-top:10px;display:none">
            <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12">
                <div id="frequencychart" class="mychart" style="width:100%;height:300px"> frequency</div>
            </div>
            <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12 ">
                <div id="percentchart" class="mychart" style="width:100%;height:300px"> percent </div>
            </div>
        </div>
        <table id="asList" class="tablegreen"></table>
    </div>
    <div class="tab-pane fade  show active" id="downtimeTab" role="tabpanel" aria-labelledby="downtimet-tab">
        <table id="dtList"></table>
    </div>
</div>

<div class="modal fade" id="CreateIncidenceModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document" style="width: 30%;min-width:150px">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="title" style="text-wrap:normal">创建 Downtime 信息</h5>
            </div>
            <div class="modal-body row">
                <div class="col-lg-6">
                    <label for="cr-department" class="form-label text-right warning-text">Department:</label>
                    <input type='text' class="form-control need create-input" data-remark="部门" id='cr-department' placeholder="---例 : ME---" />
                </div>
                <div class="col-lg-6">
                    <label for="cr-line" class="form-label text-right warning-text">Line:</label>
                    <input type='text' class="form-control need create-input" data-remark="线体" id='cr-line' placeholder="---例 : Bay13---" />
                </div>
                <div class="col-lg-6">
                    <label for="cr-project" class="form-label text-right warning-text">Project:</label>
                    <input type='text' class="form-control need create-input" data-remark="项目" id='cr-project' placeholder="---例 : AOP---" />
                </div>
                <div class="col-lg-6">
                    <label for="cr-station" class="form-label text-right warning-text">Station:</label>
                    <input type='text' class="form-control need create-input" data-remark="站位" id='cr-station' placeholder="---例 : UV---" />
                </div>
                <div class="col-lg-6">
                    <label for="cr-machine" class="form-label text-right warning-text">Machine:</label>
                    <input type='text' class="form-control need create-input" data-remark="机器名" id='cr-machine' placeholder="---例 : WUXDRX0001---" />
                </div>
                <div class="col-lg-6">
                    <label for="cr-occtime" class="form-label text-right warning-text">Start Time:</label>
                    <div class='input-group date form_datetime' id="createDT">
                        <input type='text' class="form-control need create-input" data-remark=" Downtime 发生时间" id='cr-occtime' />
                        <span class="input-group-addon">
                            <span class="fa fa-calendar"></span>
                        </span>
                    </div>
                </div>
                <div class="col-lg-12">
                    <label for="cr-issue" class="form-label text-right warning-text">Defect Code:</label>
                    <input type='text' class="form-control need create-input" data-remark="问题" id='cr-issue' placeholder="---请输入问题---" />
                </div>
                <div class="col-lg-12">
                    <label for="cr-issueremark" class="form-label text-right">Issue Description:</label>
                    <textarea type='text' class="form-control create-input" id='cr-issueremark' placeholder="---请输入问题描述---"></textarea>
                </div>
                <div class="col-lg-12">
                    <label for="cr-creator" class="form-label text-right warning-text">Reporter:</label>
                    <input type='text' class="form-control need create-input" data-remark="创建人" id='cr-creator' placeholder="---例 : W1234---" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="CreateIncidence()">Submit</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="StartRepaireModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document" style="width: 30%;min-width:150px ">
        <div class="modal-content" @*style="background-color: #b37272; color: white"*@>
            <div class="modal-header" style="background-color: #a73d3d; color: white">
                <h5 class="modal-title" id="title" style="text-wrap:normal">Check Downtime Message </h5>
            </div>
            <div class="modal-body row">
                <div class="col-lg-6">
                    <label for="sr-department" class="form-label text-right">Department:</label>
                    <input type='text' class="form-control" readonly id='sr-department' />
                </div>
                <div class="col-lg-6">
                    <label for="sr-line" class="form-label text-right">Line:</label>
                    <input type='text' class="form-control" readonly id='sr-line' />
                </div>
                <div class="col-lg-6">
                    <label for="sr-project" class="form-label text-right">Project:</label>
                    <input type='text' class="form-control" readonly id='sr-project' />
                </div>
                <div class="col-lg-6">
                    <label for="sr-station" class="form-label text-right">Station:</label>
                    <input type='text' class="form-control" readonly id='sr-station' />
                </div>
                <div class="col-lg-12">
                    <label for="sr-machine" class="form-label text-right">Machine:</label>
                    <input type='text' class="form-control" readonly id='sr-machine' />
                </div>
                <div class="col-lg-12">
                    <label for="sr-issue" class="form-label text-right">Defect Code:</label>
                    <input type='text' class="form-control" readonly id='sr-issue' />
                </div>
                <div class="col-lg-12">
                    <label for="sr-issueremark" class="form-label text-right">Issue Description:</label>
                    <textarea type='text' class="form-control" readonly id='sr-issueremark'></textarea>
                </div>
                <div class="col-lg-12">
                    <label for="sr-employee" class="form-label text-right warning-text">Employee:</label>
                    <input type='text' class="form-control" id='sr-employee' placeholder="---例 : W1234---" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="startRepaire">Go to Fix</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="CAModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document" style="width: 50%;min-width:150px">
        <div class="modal-content" @*style="background-color: #62a58a; color: white"*@>
            <div class="modal-header" style="background-color: #3e9472; color: white">
                <h5 class="modal-title" id="CA-title" style="text-wrap:normal">填写 RootCause 和 CA </h5>
            </div>
            <div class="modal-body row">
                <div class="col-lg-2">
                    <label for="ca-department" class="form-label text-right">Department:</label>
                    <input type='text' class="form-control" readonly id='ca-department' />
                </div>
                <div class="col-lg-2">
                    <label for="ca-line" class="form-label text-right">Line:</label>
                    <input type='text' class="form-control" readonly id='ca-line' />
                </div>
                <div class="col-lg-2">
                    <label for="ca-project" class="form-label text-right">Project:</label>
                    <input type='text' class="form-control" readonly id='ca-project' />
                </div>
                <div class="col-lg-3">
                    <label for="ca-station" class="form-label text-right warning-text">Station:</label>
                    <input type='text' class="form-control raca noNull" id='ca-station'  noNull="Station"/>
                </div>
                <div class="col-lg-3">
                    <label for="ca-machine" class="form-label text-right warning-text">Equipment:</label>
                    <select class="form-control raca noNull" id='ca-machine' data-size="6" title="--Select EQID--" noNull="Equipment"></select>
                </div>
                <div class="col-lg-12">
                    <label for="ca-issue" class="form-label text-right warning-text">Defect Code:</label>
                    <input type='text' class="form-control raca noNull" id='ca-issue' noNull="Defect Code"/>
                </div>
                <div class="col-lg-12">
                    <label for="ca-issueremark" class="form-label text-right">Issue Description:</label>
                    <textarea type='text' class="form-control raca" id='ca-issueremark'></textarea>
                </div>
                <div class="col-lg-4">
                    <label for="ca-employee" class="form-label text-right">Employee:</label>
                    <input type='text' class="form-control" id='ca-employee' readonly />
                </div>
                <div class="col-lg-4">
                    <label for="ca-labor" class="form-label text-right">Labor:</label>
                    <input type='number' step="1" class="form-control raca" id='ca-labor' value="1" title="1" />
                </div>
                <div class="col-lg-4">
                    <label for="caldowntime" class="form-label text-right warning-text">Calculate Downtime:</label>
                    <div class="radio-group">
                        <label style="font-weight:600"><input type='radio' name="caldowntime" value="true" /> YES</label>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <label style="font-weight:600"><input type='radio' name="caldowntime" value="false" /> NO</label>
                    </div>
                </div>
                @*downtime相关*@
                <div class="col-lg-6  downtime-item">
                    <label for="ca-starttime" class="form-label text-right warning-text">Start Time:</label>
                    <input type='text' class="form-control" id='ca-starttime' readonly />
                </div>
                <div class="col-lg-6  downtime-item">
                    <label for="ca-finishtime" class="form-label text-right warning-text">Finish Time:</label>
                    <input type='text' class="form-control" id='ca-finishtime' readonly />
                </div>
                <div class="col-lg-12  downtime-item">
                    <label for="ca-downtime" class="form-label text-right warning-text">Downtime(mins):</label>
                    <input type='text' class="form-control" id='ca-downtime' readonly />
                </div>
                @*downtime相关*@
                <div class="col-lg-6">
                    <label for="ca-rootcause" class="form-label text-right warning-text">Root Cause:</label>
                    <input type='text' class="form-control raca noNull" id='ca-rootcause' noNull="Root Cause"/>
                </div>
                <div class="col-lg-6">
                    <label for="ca-action" class="form-label text-right warning-text">Action:</label>
                    <input type='text' class="form-control raca noNull" id='ca-action' noNull="Action"/>
                </div>
                <div class="col-lg-6">
                    <label for="ca-rootcauseremark" class="form-label text-right">Root Cause Remark:</label>
                    <textarea type='text' class="form-control raca" id='ca-rootcauseremark'></textarea>
                </div>
                <div class="col-lg-6">
                    <label for="ca-actionremark" class="form-label text-right">Action Remark:</label>
                    <textarea type='text' class="form-control raca" id='ca-actionremark'></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="addCA">Submit</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="AnalysisEditModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document" style="width: 50%;min-width:150px">
        <div class="modal-content" @*style="background-color: #62a58a; color: white"*@>
            <div class="modal-header" style="background-color: #3e9472; color: white">
                <h5 class="modal-title" id="CA-title" style="text-wrap:normal">编辑纠正预防措施</h5>
            </div>
            <div class="modal-body row">
                <div class="col-lg-3">
                    <label for="analysis-department" class="form-label text-right">Department:</label>
                    <input type='text' class="form-control" readonly id='analysis-department' />
                </div>
                <div class="col-lg-3">
                    <label for="analysis-line" class="form-label text-right">Line:</label>
                    <input type='text' class="form-control" readonly id='analysis-line' />
                </div>
                <div class="col-lg-3">
                    <label for="analysis-project" class="form-label text-right">Project:</label>
                    <input type='text' class="form-control" readonly id='analysis-project' />
                </div>
                <div class="col-lg-3">
                    <label for="analysis-station" class="form-label text-right">Station:</label>
                    <input type='text' class="form-control " readonly id='analysis-station' />
                </div>
                <div class="col-lg-12">
                    <label for="analysis-issue" class="form-label text-right warning-text">Defect Code:</label>
                    <input type='text' class="form-control " readonly id='analysis-issue' />
                </div>
                @*<div class="col-lg-4">
                        <label for="ca-employee" class="form-label text-right">Employee:</label>
                        <input type='text' class="form-control" id='analysis-employee' readonly />
                    </div>*@
                <div class="col-lg-6">
                    <label for="analysis-rootcause" class="form-label text-right warning-text">Root Cause:</label>
                    <textarea class="form-control " id='analysis-rootcause' rows="6" readonly></textarea>
                </div>
                <div class="col-lg-6">
                    <label for="analysis-action" class="form-label text-right warning-text">Action:</label>
                    <textarea class="form-control " id='analysis-action' rows="6"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="EditAnalysis" onclick="EditAnalysis()">Submit</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
        </div>
    </div>
</div>

<div class="alert"></div>

<script src="~/lib/bootstrap/dist/js/select2.full.min.js" type="text/javascript"></script>
<script src="~/js/customer.js"></script>
<script src="~/js/cookie.js"></script>
<script src="~/lib/echarts/dist/js/echarts.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap-table.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap-table-export.js"></script>
<script src="~/lib/bootstrap/dist/js/tableExport.js"></script>
<script src="~/lib/bootstrap/dist/js/FileSaver.min.js"></script>
<script src="~/lib/bootstrap/dist/js/xlsx.core.min.js"></script>
<script>
    $(document).ready(function () {
        let id = GetParms("ticket");
        if (id != "" && id != null && id != 'undefined') {
            $("#id").val(id);
            GetDowntimeList();
        }
        $(".searchTime").datetimepicker({
            fontAwesome: 'font-awesome',
            format: 'yyyy-mm-dd',//hh:00:00', //时间显示的格式
            todayBtn: true, //一键选中今天的日期
            minDate: '2022/01/01',
            maxDate: 0,//今天
            pickerPosition: "bottom-left", //打开选择卡的位置
            weekStart: 1, //周开始的星期：0-6 星期日-星期六
            autoclose: true,//选好时间后自动关闭
            startView: 2,
            maxView: 4,
            minView: 2,//显示的最小选项卡：0-4 hour,day,month,year,decade
            //minuteStep: 5,
            language: 'zh-CN',
            startDate: new Date("2022-01-01"),
            endDate: new Date()
        });
        getDepartment($("#department-select"));
        getLine($('#line-select'));
        getProject($('#project-select'));
        getStation($('#station-select'));
        getDashboardSystem($("#system-select"));
        //var name = getCookie('dt-displayname');   //自动获取当前维修人员信息
    });

    //bootstrap-table 获取 downtime 信息
    function GetDowntimeList() {
        $("#dtList").bootstrapTable('destroy').bootstrapTable({
            cache: false,
            type: 'GET',
            url: '/EC/GetDowntimeList',
            queryParams: {
                id: $("#id").val(),
                Department: $("#department-select").val()[0],
                Project: $("#project-select").val()[0],
                Line: $("#line-select").val()[0],
                Station: $("#station-select").val()[0],
                Incidentstatus: $("#status-select").val()[0],
                comefrom: $("#system-select").val()[0],
                starttime: $("#start").val() ? $("#start").val() + " 00:00:00" : null,
                endtime: $("#end").val() ? $("#end").val() + " 23:59:59" : null,
                Respperson: $("#responser").val(),
            },
            showColumns: true,
            dataType: 'json',
            pagination: true,
            paginationLoop: false,
            pageSize: 10,
            pageList: '[10, 50 ,100 ,200, 500, ALL]',
            showExport: function (row, index) {
                var sUserAgent = navigator.userAgent.toLowerCase();
                var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
                var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
                var bIsMidp = sUserAgent.match(/midp/i) == "midp";
                var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
                var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
                var bIsAndroid = sUserAgent.match(/android/i) == "android";
                var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
                var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
                if (bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) {
                    return false;
                } else {
                    return true;
                }
            },
            exportDataType: 'basic', //'basic', 'all', 'selected'.
            exportTypes: ['csv', 'excel', 'xlsx'], //导出类型
            exportOptions: {
                fileName: 'Downtime List - ' + formatDate(new Date()), //文件名称设置
                worksheetName: 'Sheet1', //表格工作区名称
                tableName: 'Downtime List',
                excelstyles: ['background-color', 'color', 'font-size', 'font-weight'],
            },
            columns: [{
                field: 'id',
                title: 'Ticket No.',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'comefrom',
                title: 'System',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'creator',
                title: 'Creator',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'department',
                title: 'Department',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'project',
                title: 'Project',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'line',
                title: 'Line',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'station',
                title: 'Station Name',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'machine',
                title: 'Machine Name',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'urgentlevel',
                title: 'Ugentlevel',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'occurtime',
                title: 'Occurt Time',
                align: 'center',
                valign: 'middle',
                formatter: function (value, row, index) {
                    return new Date(value).format('yyyy-MM-dd hh:mm:ss');
                },
            }, {
                field: 'issue',
                title: 'Defect Code',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'issueremark',
                title: 'Issue Description',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'repairtime',
                title: 'Repair Time',
                align: 'center',
                valign: 'middle',
                formatter: function (value, row, index) {
                    if (value)
                        return new Date(value).format('yyyy-MM-dd hh:mm:ss');
                    else
                        return value;
                },
            }, {
                field: 'respperson',
                title: 'Response Person',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'finishtime',
                title: 'Finish Time',
                align: 'center',
                valign: 'middle',
                formatter: function (value, row, index) {
                    if (value)
                        return new Date(value).format('yyyy-MM-dd hh:mm:ss');
                    else
                        return value;
                },
            }, {
                field: 'calcdowntime',
                title: 'Calculate Downtime',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'downtime',
                title: 'DownTime(mins)',
                align: 'center',
                valign: 'middle',
                formatter: function (value, row, index) {
                    if (row['calcdowntime']) {
                        if (row['finishtime'] == null) {
                            let tmp = new Date(row['occurtime']);
                            let Downtime = new Date() - tmp;
                            return parseInt(Downtime / 1000 / 60);
                        }
                        else {
                            return parseInt(Math.abs(value / 60));
                        }
                    }
                    else {
                        return 'Null';
                    }
                },
            }, {
                field: 'labor',
                title: 'Labor',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'rootcause',
                title: 'RC',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'rootcauseremark',
                title: 'RC Description',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'action',
                title: 'CA',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'actionremark',
                title: 'CA Description',
                align: 'center',
                valign: 'middle',
                visible: false,
            }, {
                field: 'option',
                title: 'Option',
                align: 'center',
                valign: 'middle',
                formatter: function (value, row, index) {
                    if (row['incidentstatus'] == 0) {
                        return ['<button type="button" class="btn bad text-light" id="start">Attendance</button>']
                    } else if (row['incidentstatus'] == 1) {
                        return ['<button type="button" class="btn warning text-light" id="close">Close</button>']
                    } else if (row['incidentstatus'] == 2 && row['actionstatus'] == 2) {
                        return ['<button type="button" class="btn primary text-light" id="edit">RC/CA</button>']
                    } else if (row['incidentstatus'] == 2 && row['actionstatus'] == 3) {
                        return ['<button type="button" class="btn good text-light" id="view">View</button>']
                    } else {
                        return ['<button type="button" class="btn .default text-light" id="error">Default</button>']
                    }
                },
                events: {
                    "click #start": function (e, value, row, index) {
                        $("#sr-department").val(row['department']);
                        $("#sr-project").val(row['project']);
                        $("#sr-line").val(row['line']);
                        $("#sr-station").val(row['station']);
                        $("#sr-issue").val(row['issue']);
                        $("#sr-machine").val(row['machine']);
                        $("#sr-issueremark").val(row['issueremark']);
                        $("#StartRepaireModal").data("id", row['id']);
                        //$("#sr-employee").val(getCookie("dt-displayname"));
                        $("#StartRepaireModal").modal('show');
                    },
                    "click #close": function (e, value, row, index) {
                        if (confirm("确定结束维修: " + row['line'] + ' ' + row['station'] + ' : ' + row['issue'])) {
                            $.ajax({
                                url: '/EC/CloseRepaire',
                                method: 'POST',
                                data: {
                                    id: row['id'],
                                },
                                success: function (data) {
                                    showSuccess('维修结束，辛苦了!');
                                    //结束直接填写 RC & CA
                                    //if (confirm("开始填写 RC & CA ?")) {
                                    //    ShowCARA(row);
                                    //}
                                },
                                fail: function (err, status, xhr) {
                                    showWarning(err.responseText);
                                },
                                error: function (err) {
                                    showWarning(err.responseText);
                                },
                                complete: function (res) {
                                    $("#dtList").bootstrapTable("refreshOptions", { url: '/EC/GetDowntimeList' });
                                }
                            })
                        }
                    },
                    "click #edit": function (e, value, row, index) {
                        ShowCARA(row);
                    },
                    "click #view": function (e, value, row, index) {
                        ViewDowntimeInfo(row);
                    }
                }
            }, {
                field: 'analysis',
                title: 'Analysis',
                align: 'center',
                valign: 'middle',
                formatter: function (value, row, index) {
                    //显示分析页面
                    return ['<button type="button" class="btn gray" id="showanalysis">Analysis</button>']
                },
                events: {
                    "click #showanalysis": function (e, value, row, index) {
                        GetAnalysis(row);
                        $('#myTab a[href="#analysisTab"]').tab('show');
                    }
                }
            }]
        })
        $('#myTab a[href="#downtimeTab"]').tab('show')
    }

    //开始维修
    $('#startRepaire').on('click', function () {
        if ($("#sr-employee").val()) {
            $.ajax({
                url: '/EC/StartRepaire',
                method: 'POST',
                data: {
                    id: $("#StartRepaireModal").data('id'),
                    name: $("#sr-employee").val().toUpperCase(),
                },
                success: function (data) {
                    $("#StartRepaireModal").modal('hide');
                    showInfo("开始维修，祝你工作愉快!");
                },
                fail: function (err, status, xhr) {
                    showWarning(err.responseText);
                },
                error: function (err) {
                    showWarning(err.responseText);
                },
                complete: function (res) {
                    $("#dtList").bootstrapTable("refreshOptions", { url: '/EC/GetDowntimeList' });
                }
            })
        }
        else {
            showWarning("请输入维修人员工号 !");
        }
    });

    //填写CA
    function ShowCARA(row) {
        $.ajax({
            url: '/PMMS/getEQID',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                let option = '<option value=""></option>';
                if (data.indexOf(row['machine']) < 0) {
                    option += '<option value="' + row['machine'] + '">' + row['machine'] + '</option>';
                }
                for (var i = 0; i < data.length; i++) {
                    option += '<option value="' + data[i] + '">' + data[i] + '</option>';
                }
                $("#ca-machine").html(option);
            },
            fail: function (err) {
                showWarning(err.statusText);
            },
            error: function (err) {
                console.log(err);
                showWarning(err.statusText);
            }
        })

        $("#ca-machine").select2({
            tags: true,
            maximumInputLength: 40,
            minimumInputLength: 2,
            minimumResultsForSearch: 10,
            placeholder:"请输入设备ID"
        });

        $("#CA-title").html("填写 RootCause 和 CA");
        $("#ca-department").val(row['department']);
        $("#ca-project").val(row['project']);
        $("#ca-line").val(row['line']);
        //$("#ca-machine").val(row['machine']);
        $("#ca-station").val(row['station']);
        $("#ca-issue").val(row['issue']);
        $("#ca-issueremark").val(row['issueremark']);
        $("#ca-employee").val(row['respperson']);
        $("#ca-labor").val(row['labor']);
        $(':radio[name=caldowntime][value=' + row['calcdowntime'] + ']').prop('checked', 'true');
        $(':radio[name=caldowntime]').removeAttr('disabled', 'disabled');
        showDowntimeControls(row['calcdowntime'].toString());
        $("#ca-starttime").val(new Date(row['occurtime']).format('yyyy-MM-dd hh:mm:ss'));
        $("#ca-finishtime").val(new Date(row['finishtime']).format('yyyy-MM-dd hh:mm:ss'));
        $("#ca-downtime").val(parseInt(row['downtime']/60));
        $("#ca-rootcause").val(row['rootcause']);
        $("#ca-rootcauseremark").val(row['rootcauseremark']);
        $("#ca-action").val(row['action']);
        $("#ca-actionremark").val(row['actionremark']);
        $(".raca").removeAttr('readonly');
        $("#addCA").removeClass("elehide");
        $("#CAModal").data("id", row['id']);
        $("#CAModal").modal('show');
    }


    $("#addCA").on('click', function () {
        if (checkFormNoNull()) {
            var tmp = {
                id: $("#CAModal").data('id'),
                calcdowntime: $(':radio[name=caldowntime]:checked').val(),
                labor: $("#ca-labor").val(),
                rootcause: $("#ca-rootcause").val(),
                rootcauseremark: $("#ca-rootcauseremark").val(),
                action: $("#ca-action").val(),
                actionremark: $("#ca-actionremark").val(),
                station: $("#ca-station").val(),
                machine: $("#ca-machine").val(),
                issue: $("#ca-issue").val(),
                issueremark: $("#ca-issueremark").val(),
            };
            postData('/EC/RCCA', tmp)
                .then(res => {
                    if ($(':radio[name=caldowntime]:checked').val() == 'true') {
                        var issueSummary = {
                            department: $("#ca-department").val(),
                            project: $("#ca-project").val(),
                            line: $("#ca-line").val(),
                            station: $("#ca-station").val(),
                            issue: $("#ca-issue").val(),
                            rootcause: $("#ca-rootcause").val(),
                            qty: 1,
                            action: "",
                        }
                        return postData('/IssueSummary/CloseDowntime_ModifyIssueSummary', issueSummary)
                    }
                })
                .then(res => {
                    $("#CAModal").modal('hide');
                    showSuccess("完成!");
                    $("#dtList").bootstrapTable("refreshOptions", { url: '/EC/GetDowntimeList' });
                })
                .catch(err => {
                    showWarning(err);
                    $("#dtList").bootstrapTable("refreshOptions", { url: '/EC/GetDowntimeList' });
                })
        }
    })

    //查看downtime信息
    function ViewDowntimeInfo(row) {
        let option = '<option value="' + row['machine'] + '">' + row['machine'] + '</option>';
        $("#ca-machine").html(option);
        $("#ca-machine").select2({
            readonly: true,
            disable:true,
        });

        $("#CA-title").html("查看 Downtime 信息");
        $("#ca-department").val(row['department']);
        $("#ca-project").val(row['project']);
        $("#ca-line").val(row['line']);
        $("#ca-machine").val(row['machine']);
        $("#ca-station").val(row['station']);
        $("#ca-issue").val(row['issue']);
        $("#ca-issueremark").val(row['issueremark']);
        $("#ca-employee").val(row['respperson']);
        $("#ca-labor").val(row['labor']);
        $(':radio[name=caldowntime][value=' + row['calcdowntime'] + ']').prop('checked', 'true');
        $(':radio[name=caldowntime]').attr('disabled', 'disabled');
        showDowntimeControls(row['calcdowntime'].toString());
        $("#ca-starttime").val(new Date(row['occurtime']).format('yyyy-MM-dd hh:mm:ss'));
        $("#ca-finishtime").val(new Date(row['finishtime']).format('yyyy-MM-dd hh:mm:ss'));
        $("#ca-downtime").val(parseInt(row['downtime']/60));
        $("#ca-rootcause").val(row['rootcause']);
        $("#ca-rootcauseremark").val(row['rootcauseremark']);
        $("#ca-action").val(row['action']);
        $("#ca-actionremark").val(row['actionremark']);
        $(".raca").attr('readonly', true);
        $(".raca").attr('disable', "disable");

        $("#addCA").addClass("elehide");
        $("#CAModal").data("id", row['id']);
        $("#CAModal").modal('show');
    }

    //downtime相关控件是否显示
    $(':radio[name=caldowntime]').on('change', function (e) {
        showDowntimeControls(e.target.defaultValue);
    })
    function showDowntimeControls(flag) {
        if (flag == "false") {
            console.log("NO");
            $(".downtime-item").addClass("elehide");
        } else {
            console.log("YES");
            $(".downtime-item").removeClass("elehide");
        }
    }

    //创建DowntimeIncidence
    $("#new").on('click', function () {
        $(".create-input").val("");
        $("#createDT").datetimepicker({
            fontAwesome: 'font-awesome',
            format: 'yyyy-mm-dd hh:ii',//hh:00:00', //时间显示的格式
            todayBtn: true, //一键选中今天的日期
            minDate: '2022/01/01',
            maxDate: 0,//今天
            pickerPosition: "bottom-left", //打开选择卡的位置
            weekStart: 1, //周开始的星期：0-6 星期日-星期六
            autoclose: true,//选好时间后自动关闭
            startView: 1,
            maxView: 4,
            minView: 0,//显示的最小选项卡：0-4 hour,day,month,year,decade
            minuteStep: 5,
            language: 'zh-CN',
            startDate: getDay(-1, '-'),
            endDate: new Date(),
        });
        $("#CreateIncidenceModal").modal("show");
    })
    function CreateIncidence() {
        var items = $(".need");
        for (var i = 0; i < items.length; i++) {
            console.log($(items[i]));
            if (!$(items[i]).val()) {
                showWarning("请填写" + $(items[i]).data("remark"));
                return;
            }
        }
        $.ajax({
            url: '/EC/CreateDowmtimeIncident',
            method: 'POST',
            data: {
                comefrom: "Downtime System",
                alarmtype: "Downtime Incident Created",
                project: $("#cr-project").val(),
                line: $("#cr-line").val(),
                station: $("#cr-station").val(),
                occurtime: $("#cr-occtime").val(),
                calcdowntime: "true",
                department: $("#cr-department").val(),
                issue: $("#cr-issue").val(),
                issueremark: $("#cr-issueremark").val(),
                creator: $("#cr-creator").val(),
                machine: $("#cr-machine").val(),
                action: "",
            },
            success: function (data) {
                $("#CreateIncidenceModal").modal('hide');
                showInfo("Downtime信息已创建，请尽快维修!");
            },
            fail: function (err, status, xhr) {
                showWarning(err.responseText);
            },
            error: function (err) {
                showWarning(err.responseText);
            },
            complete: function (res) {
                $('#department-select').val($("#cr-department").val());
                $('#project-select').val($("#cr-project").val())
                $('#line-select').val($("#cr-line").val())
                $('#station-select').val($("#cr-station").val())
                $("#dtList").bootstrapTable("refreshOptions", { url: '/EC/GetDowntimeList' });
            }
        })
    }

    //显示分析结果
    function GetAnalysis(row) {
        $("#asList").bootstrapTable('destroy').bootstrapTable({
            cache: false,
            type: 'GET',
            url: '/IssueSummary/GetIssueSummary',
            queryParams: {
                Department: row['department'],
                Project: row['project'],
                Line: row['line'],
                Station: row['station'],
                issue: row['issue'],
            },
            dataType: 'json',
            columns: [{
                field: 'issue',
                title: 'Defect Code',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'totalqty',
                title: 'Accumulative QTY',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'totalPercent',
                title: 'Percentage%',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'rootcause',
                title: 'Root Cause',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'qty',
                title: 'Sub QTY',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'subPercent',
                title: 'Sub Percentage%',
                align: 'center',
                valign: 'middle',
            }, {
                field: 'action',
                title: 'Analysis Steps',
                align: 'center',
                valign: 'middle',
            },],
            onLoadSuccess: function (data) {
                var data = $('#asList').bootstrapTable('getData', true);
                //合并单元格
                mergeCells(data, "issue", 1, $('#asList'));

                //增加ecahrts
                var ecahrtsData = []
                var legen = []
                var piedata = [];
                for (var prop in data) {
                    legen.push(data[prop]['rootcause']);
                    ecahrtsData.push(data[prop]['qty']);
                    piedata.push({
                        value: data[prop]['qty'],
                        name: data[prop]['rootcause'],
                    });
                }
                FrequencyChart(ecahrtsData, legen);
                PercentChart(piedata);
            }
        });
    }
    //修改分析结果的action, 未启用
    function EditAnalysis() {
        $.ajax({
            url: '/IssueSummary/EditIssueSummary_Action',
            method: 'POST',
            data: {
                id: $("#AnalysisEditModal").data('id'),
                action: $("#analysis-action").val(),
                //correctiveaction: row['correctiveaction'],
                editor: "Auto",
            },
            success: function (data) {
                console.log(data);
            },
            error: function (err) {
                alert(err.responseText);
            },
            complete: function (res) {
                $("#asList").bootstrapTable("refreshOptions", { url: "/IssueSummary/GetIssueSummary" });
                $("#AnalysisEditModal").modal('hide');
            }
        })
    }
    // analysis 界面现实的echarts
    var frequencychart;
    var percentchart;
    function FrequencyChart(data, legen) {
        console.log(data, legen);
        $("#frequencychart").css('width', $("#myTabContent").width() * 0.5 - 10);
        var chartDom = document.getElementById('frequencychart');
        if (frequencychart != null && frequencychart != "" && frequencychart != undefined) {
            frequencychart.dispose();//解决echarts dom已经加载的报错
        }
        frequencychart = echarts.init(chartDom);
        var option = {
            title: {
                text: 'RootCause Frequence',
                left: 'center',
                textStyle: {
                    fontSize: 18,
                }
            },
            xAxis: {
                data: legen,
                type: 'category',
                axisTick: {
                    show: false
                },
                axisLine: {
                    show: false
                },
                z: 10
            },
            yAxis: {
                axisLine: {
                    show: false
                },
                axisTick: {
                    show: false
                },
                axisLabel: {
                    color: '#999'
                }
            },
            dataZoom: [
                {
                    type: 'inside'
                }
            ],
            series: [
                {
                    type: 'bar',
                    showBackground: true,
                    label: {
                        show: true,
                    },
                    //itemStyle: {
                    //    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    //        { offset: 0, color: '#83bff6' },
                    //        { offset: 0.5, color: '#188df0' },
                    //        { offset: 1, color: '#188df0' }
                    //    ])
                    //},
                    //emphasis: {
                    //    itemStyle: {
                    //        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    //            { offset: 0, color: '#2378f7' },
                    //            { offset: 0.7, color: '#2378f7' },
                    //            { offset: 1, color: '#83bff6' }
                    //        ])
                    //    }
                    //},
                    data: data,
                }
            ]
        };
        frequencychart.setOption(option);
        console.log(option);
    }
    function PercentChart(data) {
        $("#percentchart").css('width', $("#myTabContent").width() * 0.5 - 10);
        var chartDom = document.getElementById('percentchart');
        if (percentchart != null && percentchart != "" && percentchart != undefined) {
            percentchart.dispose();//解决echarts dom已经加载的报错
        }
        percentchart = echarts.init(chartDom);
        var option = {
            title: {
                text: 'RootCause Percentage',
                left: 'center',
                textStyle: {
                    fontSize: 18,
                }
            },
            tooltip: {
                trigger: 'item'
            },
            legend: {
                type: 'scroll',
                orient: 'vertical',
                right: 10,
                top: 20,
                bottom: 20,
            },
            series: [
                {
                    name: 'RootCause',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    //itemStyle: {
                    //    borderRadius: 10,
                    //    borderColor: '#fff',
                    //    borderWidth: 2
                    //},
                    //label: {
                    //    show: false,
                    //    position: 'center'
                    //},
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '20',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: data
                }
            ]
        };
        percentchart.setOption(option);
    }
</script>
